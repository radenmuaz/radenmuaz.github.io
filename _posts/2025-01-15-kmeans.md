---
title: 'K-means clustering with Pyscript'
date: 2025-01-15
permalink: /posts/2025/01/kmeans_with_pyscript/
tags:
  - cool posts
  - category1
  - category2
---

K-means clustering is a unsupervised learning to group data points to pre-defined number of groups.

<html>
    <head>
        <!-- Recommended meta tags -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    </head>
    <body>
        <section class="pyscript">
            <div id="mpl"></div>
            <script type="py-editor"
             config='{"packages":["numpy", "matplotlib"], "sync_main_only": true}'>
             {% raw %}
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation
from matplotlib.widgets import Button
from pyscript import display

def generate_data():
    np.random.seed(1)
    data1 = np.random.normal(loc=[2, 2], scale=1, size=(100, 2))
    data2 = np.random.normal(loc=[6, 6], scale=1, size=(100, 2))
    data3 = np.random.normal(loc=[10, 2], scale=1, size=(100, 2))
    return np.vstack([data1, data2, data3])

def initialize_centroids(data, k):
    indices = np.random.choice(len(data), k, replace=False)
    return data[indices]

def assign_clusters(data, centroids):
    distances = np.linalg.norm(data[:, np.newaxis] - centroids, axis=2)
    return np.argmin(distances, axis=1)

def update_centroids(data, labels, k):
    return np.array([data[labels == i].mean(axis=0) for i in range(k)])

def k_means_with_animation(data, k, max_iters=100, tol=1e-4):
    centroids = initialize_centroids(data, k)
    history = []  # To store centroids and labels for each iteration

    for _ in range(max_iters):
        old_centroids = centroids
        labels = assign_clusters(data, centroids)
        centroids = update_centroids(data, labels, k)
        history.append((centroids.copy(), labels.copy()))

        if np.linalg.norm(centroids - old_centroids) < tol:
            break

    return history

# Main
if __name__ == "__main__":
    data = generate_data()
    k = 3
    history = k_means_with_animation(data, k)

    # Set up the plot
    fig, ax = plt.subplots()
    scatter = ax.scatter(data[:, 0], data[:, 1], c='gray', marker='o', alpha=0.6, label='Data points')
    centroids_scatter = ax.scatter([], [], c='red', marker='X', s=200, label='Centroids')
    ax.legend()
    ax.set_title("K-Means Clustering")
    ax.set_xlabel("X")
    ax.set_ylabel("Y")

    frame_idx = [0]  # To keep track of the current frame

    def update(frame):
        centroids, labels = history[frame]
        scatter.set_array(labels)
        centroids_scatter.set_offsets(centroids)
        return scatter, centroids_scatter
    
    from matplotlib_pyodide.browser_backend import TimerWasm

    class Timer(TimerWasm):
        def __init__(self, interval=None):
            self._timer = None
            super().__init__(interval=interval)
    ani = FuncAnimation(fig, update, frames=len(history), blit=True,
    event_source=Timer(interval=500), repeat=False)

    from pyscript import document

    animation = document.getElementById("mpl")
    animation.replaceChildren(
        document.createRange().createContextualFragment(ani.to_jshtml())
    )
    #display(fig, target="mpl")
    {% endraw %}
            </script>
          </section>
  </body>

</html>
